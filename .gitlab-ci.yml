stages:
  - verify
  - build

flake8:
  image: python:3
  stage: verify
  before_script:
    - pip install flake8
  script:
    - flake8 .

build_container:
  image: quay.io/redhat-github-actions/buildah-runner:latest
  stage: build
  before_script:
    - export BUILDAH_FORMAT=docker
    - export REGISTRY_AUTH_FILE=${HOME}/auth.json
    - echo "$CI_REGISTRY_PASSWORD" | buildah login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
  script:
    - buildah bud -t $CI_REGISTRY_IMAGE/radosgw-exporter:latest .
    - if [ "$CI_COMMIT_REF_NAME" == "main" ]; then buildah push $CI_REGISTRY_IMAGE/radosgw-exporter:latest; fi

release_build:
  image: quay.io/redhat-github-actions/buildah-runner:latest
  stage: build
  before_script:
    - export BUILDAH_FORMAT=docker
    - echo "$CI_REGISTRY_PASSWORD" | buildah login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
  script:
    - buildah bud -t $CI_REGISTRY_IMAGE/radosgw-exporter:$CI_COMMIT_REF_NAME .
    - buildah push $CI_REGISTRY_IMAGE/radosgw-exporter:$CI_COMMIT_REF_NAME
  only:
    - tags
